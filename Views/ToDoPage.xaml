<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:PersonalPlannerApp.ViewModels"
             x:Class="PersonalPlannerApp.Views.ToDoPage"
             x:Name="TheToDoPage" 
             Title="" 
             BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#121212}">

    <Grid RowDefinitions="Auto, Auto, *" Padding="20" RowSpacing="15">

        <Label Text="My Tasks"
               FontSize="30"
               FontAttributes="Bold"
               TextColor="{AppThemeBinding Light=Black, Dark=White}"
               Grid.Row="0" />

        <Frame Grid.Row="1" CornerRadius="15" Padding="15" 
               BackgroundColor="{AppThemeBinding Light=White, Dark=#252525}">
            
            <Frame.BorderColor>Transparent</Frame.BorderColor>

            <Frame.Triggers>
                <DataTrigger TargetType="Frame" Binding="{Binding IsEditing}" Value="True">
                    <Setter Property="BorderColor" Value="OrangeRed" />
                </DataTrigger>
                <DataTrigger TargetType="Frame" Binding="{Binding IsEditing}" Value="False">
                    <Setter Property="BorderColor" Value="Transparent" />
                </DataTrigger>
            </Frame.Triggers>

            <Grid RowDefinitions="Auto, Auto" RowSpacing="10">
                
                <Grid ColumnDefinitions="*, Auto" ColumnSpacing="10" Grid.Row="0">
                    <Entry Placeholder="I need to..." Text="{Binding NewTaskText}" 
                           PlaceholderColor="Gray" TextColor="{AppThemeBinding Light=Black, Dark=White}"
                           FontSize="16" Grid.Column="0" />
                    
                    <Button Text="{Binding StateButtonText}" 
                            Command="{Binding AddTaskCommand}"
                            WidthRequest="50" HeightRequest="50" CornerRadius="25"
                            BackgroundColor="{AppThemeBinding Light=Black, Dark=#52D1DC}"
                            TextColor="{AppThemeBinding Light=White, Dark=Black}"
                            Grid.Column="1"/>
                </Grid>

                <ScrollView Grid.Row="1" Orientation="Horizontal" HorizontalScrollBarVisibility="Never">
                    <HorizontalStackLayout Spacing="15" VerticalOptions="Center">
                        
                        <HorizontalStackLayout Spacing="5" VerticalOptions="Center">
                            <Label Text="📅" VerticalOptions="Center"/>
                            <CheckBox IsChecked="{Binding HasDueDate}" Color="{AppThemeBinding Light=Black, Dark=#52D1DC}"/>
                            <DatePicker Date="{Binding SelectedDate}" IsVisible="{Binding HasDueDate}" TextColor="{AppThemeBinding Light=Black, Dark=White}"/>
                        </HorizontalStackLayout>

                        <Frame Padding="12,6" CornerRadius="8" 
                               BackgroundColor="{Binding CategoryButtonColor}" 
                               BorderColor="Transparent">
                            <Label Text="{Binding SelectedCategory}" TextColor="White" FontAttributes="Bold"/>
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding CycleCategoryCommand}"/>
                            </Frame.GestureRecognizers>
                        </Frame>

                        <Frame Padding="12,6" CornerRadius="8" 
                               BackgroundColor="{Binding PriorityButtonColor}" 
                               BorderColor="Transparent">
                            <Label Text="{Binding SelectedPriority}" TextColor="White" FontAttributes="Bold"/>
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding CyclePriorityCommand}"/>
                            </Frame.GestureRecognizers>
                        </Frame>

                    </HorizontalStackLayout>
                </ScrollView>
            </Grid>
        </Frame>

        <CollectionView Grid.Row="2" 
                        ItemsSource="{Binding GroupedTasks}"
                        IsGrouped="True"
                        SelectionMode="None"> 
            
            <CollectionView.ItemsLayout>
                <LinearItemsLayout Orientation="Vertical" ItemSpacing="10" />
            </CollectionView.ItemsLayout>

            <CollectionView.EmptyView>
                <ContentView>
                    <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="20" Margin="0,50,0,0">
                        <Label Text="🤖" 
                               FontSize="80" 
                               HorizontalOptions="Center" />
                        
                        <Label Text="There is nothing to do." 
                               FontSize="18" 
                               TextColor="Gray" 
                               FontAttributes="Bold"
                               HorizontalOptions="Center" />
                        
                        <Label Text="Enjoy the moment or add a new to-do above. ☕" 
                               FontSize="16" 
                               TextColor="Gray" 
                               HorizontalOptions="Center" />
                    </VerticalStackLayout>
                </ContentView>
            </CollectionView.EmptyView>
            <CollectionView.GroupHeaderTemplate>
                <DataTemplate>
                    <Grid Padding="0,15,0,5" ColumnDefinitions="*, Auto">
                        <Label Text="{Binding DisplayName}" FontSize="18" FontAttributes="Bold" TextColor="{AppThemeBinding Light=#333, Dark=#ccc}" VerticalOptions="Center" Grid.Column="0"/>
                        <Label Text="{Binding StateIcon}" FontSize="18" TextColor="Gray" VerticalOptions="Center" Grid.Column="1" Margin="0,0,10,0"/>
                        <Grid.GestureRecognizers>
                            <TapGestureRecognizer 
                                Command="{Binding Source={x:Reference TheToDoPage}, Path=BindingContext.ToggleGroupCommand}"
                                CommandParameter="{Binding .}" />
                        </Grid.GestureRecognizers>
                    </Grid>
                </DataTemplate>
            </CollectionView.GroupHeaderTemplate>

           <CollectionView.ItemTemplate>
                <DataTemplate>
                    <SwipeView>

                        <SwipeView.RightItems>
                            <SwipeItems Mode="Reveal">
                                <SwipeItem Text="Delete" 
                                           BackgroundColor="#FF3B30" 
                                           Command="{Binding Source={x:Reference TheToDoPage}, Path=BindingContext.DeleteTaskCommand}"
                                           CommandParameter="{Binding .}"/>
                            </SwipeItems>
                        </SwipeView.RightItems>

                        <Grid BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#121212}"> 
                            <Frame CornerRadius="12" Padding="10" BorderColor="Transparent" BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}" Margin="0,0,0,0">
                                
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer 
                                        Command="{Binding Source={x:Reference TheToDoPage}, Path=BindingContext.EditTaskCommand}"
                                        CommandParameter="{Binding .}" />
                                </Frame.GestureRecognizers>
                                
                                <Grid ColumnDefinitions="5, *, Auto" ColumnSpacing="10">
                                    
                                    <BoxView Color="{Binding CategoryColor}" WidthRequest="5" CornerRadius="2" VerticalOptions="Fill" Grid.Column="0"/>
                                    
                                    <StackLayout Grid.Column="1" VerticalOptions="Center">
                                        <Label Text="{Binding Title}" FontSize="16" TextColor="{AppThemeBinding Light=Black, Dark=White}">
                                            <Label.Triggers>
                                                <DataTrigger TargetType="Label" Binding="{Binding IsCompleted}" Value="True">
                                                    <Setter Property="TextDecorations" Value="Strikethrough" />
                                                    <Setter Property="TextColor" Value="Gray" />
                                                </DataTrigger>
                                            </Label.Triggers>
                                        </Label>
                                        <Label Text="{Binding DueDate, StringFormat='Due: {0:dd MMM}'}" FontSize="12" TextColor="Gray"/>
                                    </StackLayout>
                                    
                                    <CheckBox IsChecked="{Binding IsCompleted}" 
                                              Grid.Column="2" 
                                              Color="{AppThemeBinding Light=Black, Dark=White}"
                                              CheckedChanged="CheckBox_CheckedChanged"/>
                                </Grid>
                            </Frame>
                        </Grid>
                        
                    </SwipeView>
                </DataTemplate>
            </CollectionView.ItemTemplate>
            
        </CollectionView>

    </Grid>
</ContentPage>