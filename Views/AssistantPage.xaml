<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:helpers="clr-namespace:PersonalPlannerApp.Helpers"
             xmlns:vm="clr-namespace:PersonalPlannerApp.ViewModels"
             xmlns:models="clr-namespace:PersonalPlannerApp.Models"
             x:Class="PersonalPlannerApp.Views.AssistantPage"
             Title="Assistant"
             BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#121212}">

    <ContentPage.Resources>
        <helpers:ChatColorConverter x:Key="ChatConverter" />
    </ContentPage.Resources>

    <Grid RowDefinitions="*, Auto" RowSpacing="0">
        
        <CollectionView Grid.Row="0" ItemsSource="{Binding Messages}">
            <CollectionView.ItemsLayout>
                <LinearItemsLayout Orientation="Vertical" ItemSpacing="10" />
            </CollectionView.ItemsLayout>
            <CollectionView.Header><BoxView HeightRequest="15" Color="Transparent"/></CollectionView.Header>
            <CollectionView.Footer>
                <BoxView HeightRequest="15" Color="{AppThemeBinding Light=#F5F5F5, Dark=#121212}"/>
            </CollectionView.Footer>

            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:ChatMessage">
                    <Grid Padding="15,2">
                        <Border HorizontalOptions="{Binding IsUser, Converter={StaticResource ChatConverter}}"
                                StrokeShape="RoundRectangle 18" Padding="12" StrokeThickness="0">
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#E1F5FE, Dark=#103550}" />
                                    <Style.Triggers>
                                        <DataTrigger TargetType="Border" Binding="{Binding IsUser}" Value="True">
                                            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#C5CAE9, Dark=#1A237E}" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                            <Label Text="{Binding Text}" TextColor="{AppThemeBinding Light=Black, Dark=White}" MaximumWidthRequest="250"/>
                        </Border>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <VerticalStackLayout Grid.Row="1" Padding="15,10,15,30" Spacing="12" 
                             BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}">
            
            <FlexLayout BindableLayout.ItemsSource="{Binding SuggestedQuestions}" Wrap="Wrap" JustifyContent="Center">
                <BindableLayout.ItemTemplate>
                    <DataTemplate>
                        <Border StrokeShape="RoundRectangle 20" Stroke="{AppThemeBinding Light=#DDD, Dark=#444}" BackgroundColor="{AppThemeBinding Light=White, Dark=#252525}" Margin="3" Padding="10,5">
                            <Label Text="{Binding .}" FontSize="11" TextColor="{AppThemeBinding Light=Gray, Dark=#B0BEC5}"/>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:AssistantViewModel}}, Path=SuggestionCommand}" CommandParameter="{Binding .}"/>
                            </Border.GestureRecognizers>
                        </Border>
                    </DataTemplate>
                </BindableLayout.ItemTemplate>
            </FlexLayout>

            <Grid ColumnDefinitions="*, Auto" ColumnSpacing="10">
                <Border StrokeShape="RoundRectangle 25" BackgroundColor="{AppThemeBinding Light=White, Dark=#252525}" Stroke="#EEE" Padding="15,0">
                    <Entry Placeholder="Ask me anything..." Text="{Binding UserInput}" TextColor="{AppThemeBinding Light=Black, Dark=White}" HeightRequest="50"/>
                </Border>
                
                <Border Grid.Column="1" HeightRequest="50" WidthRequest="50" StrokeShape="RoundRectangle 25" 
                        BackgroundColor="{AppThemeBinding Light=Black, Dark=White}">
                    <Border.GestureRecognizers><TapGestureRecognizer Command="{Binding SendCommand}" /></Border.GestureRecognizers>
                    <Label Text="+" FontSize="28" TextColor="{AppThemeBinding Light=White, Dark=Black}" 
                           HorizontalOptions="Center" VerticalOptions="Center" />
                </Border>
            </Grid>
        </VerticalStackLayout>
    </Grid>
</ContentPage>